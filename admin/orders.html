<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/img/myIcon.png" type="image/png">
    <title>Admin Paneli - Siparişler</title>
    <link rel="stylesheet" href="admin.css">
    <!-- Font Awesome CDN eklendi -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2d6a4f;
            --primary-light: #40916c;
            --secondary-color: #333333;
            --light-color: #d8f3dc;
            --gray-color: #6c757d;
            --dark-gray: #343a40;
            --light-gray: #e9ecef;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar {
            background-color: var(--primary-light);
            color: #fff;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .sidebar-menu {
            flex-grow: 1;
        }

        .sidebar-menu a {
            color: rgba(255, 255, 255, 0.8);
        }

        .sidebar-menu a:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .sidebar-menu a.active {
            background-color: var(--gray-color);
            color: #fff;
        }

        .stats-card {
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .table th {
            background-color: var(--light-gray);
            color: var(--secondary-color);
            font-weight: 600;
        }

        .table td {
            vertical-align: middle;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-light);
            border-color: var(--primary-light);
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-hazirlaniyor {
            background-color: #ffc107;
            color: #212529;
        }

        .status-yolda {
            background-color: #17a2b8;
            color: white;
        }

        .status-tamamlandi {
            background-color: var(--primary-color);
            color: white;
        }

        .status-iptal {
            background-color: #dc3545;
            color: white;
        }

        .search-box {
            border-radius: 20px;
            border: 1px solid #ced4da;
            padding: 8px 15px;
            width: 300px;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(45, 106, 79, 0.25);
        }

        .order-detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-close {
            float: right;
            cursor: pointer;
            font-size: 1.5rem;
        }

        .filter-section {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>E-Ticaret Admin</h3>
            </div>
            <ul class="sidebar-menu">
                <li>
                    <a href="dashboard.html">
                        <i class="fas fa-tachometer-alt"></i>
                        Dashboard
                    </a>
                </li>
                <li>
                    <a href="categories.html">
                        <i class="fas fa-list"></i>
                        Kategoriler
                    </a>
                </li>
                <li>
                    <a href="products.html">
                        <i class="fas fa-box"></i>
                        Ürünler
                    </a>
                </li>
                <li>
                    <a href="orders.html" class="active">
                        <i class="fas fa-shopping-cart"></i>
                        Siparişler
                    </a>
                </li>
                <!-- Admin bilgileri ve çıkış butonu buraya dinamik olarak eklenecek -->
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="page-header">
                <h1 style="color: var(--secondary-color);">Siparişler</h1>
                <div>
                    <span style="background-color: var(--secondary-color); color: white; padding: 5px 10px; border-radius: 4px;">
                        Tarih: <span id="current-date">1 Mayıs 2025</span>
                    </span>
                </div>
            </div>

            <!-- Siparişler Tablosu -->
            <div style="background-color: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <div class="page-header" style="margin-bottom: 20px;">
                    <h2 style="color: var(--secondary-color);">Sipariş Bilgileri</h2>
                </div>
                
                <div style="display: grid; gap: 20px;">
                    <!-- Örnek sipariş 1 -->
                    <div style="border: 1px solid #e9ecef; border-radius: 8px; overflow: hidden;">
                        <div style="background-color: #f8f9fa; padding: 10px 15px; border-bottom: 1px solid #e9ecef;">
                            <span style="font-weight: 600;">Sipariş Kodu:</span> ORD12345
                        </div>
                        <div style="padding: 15px; border-bottom: 1px solid #e9ecef;">
                            <span style="font-weight: 600;">Ürünler:</span>
                            <div style="margin-top: 5px; padding-left: 10px;">
                                <div style="padding: 3px 0;">• ASUS VivoBook 15 Laptop (x1)</div>
                            </div>
                        </div>
                        <div style="padding: 10px 15px; border-bottom: 1px solid #e9ecef; display: flex;">
                            <div style="flex: 1;">
                                <span style="font-weight: 600;">Tarih:</span> 01.05.2025
                            </div>
                            <div style="flex: 1;">
                                <span style="font-weight: 600;">Müşteri:</span> Ahmet Yılmaz
                            </div>
                        </div>
                        <div style="padding: 10px 15px; border-bottom: 1px solid #e9ecef; display: flex;">
                            <div style="flex: 1;">
                                <span style="font-weight: 600;">Toplam:</span> 1.250 TL
                            </div>
                            <div style="flex: 1;">
                                <span style="font-weight: 600;">Durum:</span> 
                                <span class="status-badge status-hazirlaniyor">Hazırlanıyor</span>
                            </div>
                        </div>
                        <div style="padding: 10px 15px; text-align: right;">
                            <span style="font-weight: 600;">İşlemler:</span>
                            <button class="btn-detail" style="background: transparent; border: none; color: var(--primary-color); cursor: pointer;" data-order-id="ORD12345">
                                <i class="fas fa-eye"></i> Detay
                            </button>
                        </div>
                    </div>
                    
                    <!-- Örnek sipariş 2 -->
                    <div style="border: 1px solid #e9ecef; border-radius: 8px; overflow: hidden;">
                        <div style="background-color: #f8f9fa; padding: 10px 15px; border-bottom: 1px solid #e9ecef;">
                            <span style="font-weight: 600;">Sipariş Kodu:</span> ORD12346
                        </div>
                        <div style="padding: 15px; border-bottom: 1px solid #e9ecef;">
                            <span style="font-weight: 600;">Ürünler:</span>
                            <div style="margin-top: 5px; padding-left: 10px;">
                                <div style="padding: 3px 0;">• Samsung Galaxy S21 (x1)</div>
                                <div style="padding: 3px 0;">• Telefon Kılıfı (x2)</div>
                                <div style="padding: 3px 0;">• Ekran Koruyucu (x1)</div>
                            </div>
                        </div>
                        <div style="padding: 10px 15px; border-bottom: 1px solid #e9ecef; display: flex;">
                            <div style="flex: 1;">
                                <span style="font-weight: 600;">Tarih:</span> 30.04.2025
                            </div>
                            <div style="flex: 1;">
                                <span style="font-weight: 600;">Müşteri:</span> Mehmet Demir
                            </div>
                        </div>
                        <div style="padding: 10px 15px; border-bottom: 1px solid #e9ecef; display: flex;">
                            <div style="flex: 1;">
                                <span style="font-weight: 600;">Toplam:</span> 3.560 TL
                            </div>
                            <div style="flex: 1;">
                                <span style="font-weight: 600;">Durum:</span> 
                                <span class="status-badge status-yolda">Kargoda</span>
                            </div>
                        </div>
                        <div style="padding: 10px 15px; text-align: right;">
                            <span style="font-weight: 600;">İşlemler:</span>
                            <button class="btn-detail" style="background: transparent; border: none; color: var(--primary-color); cursor: pointer;" data-order-id="ORD12346">
                                <i class="fas fa-eye"></i> Detay
                            </button>
                        </div>
                    </div>
                    
                    <!-- Örnek sipariş 3 -->
                    <div style="border: 1px solid #e9ecef; border-radius: 8px; overflow: hidden;">
                        <div style="background-color: #f8f9fa; padding: 10px 15px; border-bottom: 1px solid #e9ecef;">
                            <span style="font-weight: 600;">Sipariş Kodu:</span> ORD12347
                        </div>
                        <div style="padding: 15px; border-bottom: 1px solid #e9ecef;">
                            <span style="font-weight: 600;">Ürünler:</span>
                            <div style="margin-top: 5px; padding-left: 10px;">
                                <div style="padding: 3px 0;">• Bluetooth Kulaklık (x1)</div>
                            </div>
                        </div>
                        <div style="padding: 10px 15px; border-bottom: 1px solid #e9ecef; display: flex;">
                            <div style="flex: 1;">
                                <span style="font-weight: 600;">Tarih:</span> 28.04.2025
                            </div>
                            <div style="flex: 1;">
                                <span style="font-weight: 600;">Müşteri:</span> Ayşe Kaya
                            </div>
                        </div>
                        <div style="padding: 10px 15px; border-bottom: 1px solid #e9ecef; display: flex;">
                            <div style="flex: 1;">
                                <span style="font-weight: 600;">Toplam:</span> 980 TL
                            </div>
                            <div style="flex: 1;">
                                <span style="font-weight: 600;">Durum:</span> 
                                <span class="status-badge status-tamamlandi">Tamamlandı</span>
                            </div>
                        </div>
                        <div style="padding: 10px 15px; text-align: right;">
                            <span style="font-weight: 600;">İşlemler:</span>
                            <button class="btn-detail" style="background: transparent; border: none; color: var(--primary-color); cursor: pointer;" data-order-id="ORD12347">
                                <i class="fas fa-eye"></i> Detay
                            </button>
                        </div>
                    </div>
                    
                    <!-- Örnek sipariş 4 -->
                    <div style="border: 1px solid #e9ecef; border-radius: 8px; overflow: hidden;">
                        <div style="background-color: #f8f9fa; padding: 10px 15px; border-bottom: 1px solid #e9ecef;">
                            <span style="font-weight: 600;">Sipariş Kodu:</span> ORD12348
                        </div>
                        <div style="padding: 15px; border-bottom: 1px solid #e9ecef;">
                            <span style="font-weight: 600;">Ürünler:</span>
                            <div style="margin-top: 5px; padding-left: 10px;">
                                <div style="padding: 3px 0;">• Elektrikli Süpürge (x1)</div>
                                <div style="padding: 3px 0;">• Yedek Filtre Seti (x1)</div>
                            </div>
                        </div>
                        <div style="padding: 10px 15px; border-bottom: 1px solid #e9ecef; display: flex;">
                            <div style="flex: 1;">
                                <span style="font-weight: 600;">Tarih:</span> 27.04.2025
                            </div>
                            <div style="flex: 1;">
                                <span style="font-weight: 600;">Müşteri:</span> Fatma Şahin
                            </div>
                        </div>
                        <div style="padding: 10px 15px; border-bottom: 1px solid #e9ecef; display: flex;">
                            <div style="flex: 1;">
                                <span style="font-weight: 600;">Toplam:</span> 2.150 TL
                            </div>
                            <div style="flex: 1;">
                                <span style="font-weight: 600;">Durum:</span> 
                                <span class="status-badge status-iptal">İptal Edildi</span>
                            </div>
                        </div>
                        <div style="padding: 10px 15px; text-align: right;">
                            <span style="font-weight: 600;">İşlemler:</span>
                            <button class="btn-detail" style="background: transparent; border: none; color: var(--primary-color); cursor: pointer;" data-order-id="ORD12348">
                                <i class="fas fa-eye"></i> Detay
                            </button>
                        </div>
                    </div>
                    
                    <!-- Örnek sipariş 5 -->
                    <div style="border: 1px solid #e9ecef; border-radius: 8px; overflow: hidden;">
                        <div style="background-color: #f8f9fa; padding: 10px 15px; border-bottom: 1px solid #e9ecef;">
                            <span style="font-weight: 600;">Sipariş Kodu:</span> ORD12349
                        </div>
                        <div style="padding: 15px; border-bottom: 1px solid #e9ecef;">
                            <span style="font-weight: 600;">Ürünler:</span>
                            <div style="margin-top: 5px; padding-left: 10px;">
                                <div style="padding: 3px 0;">• Apple Watch Series 7 (x1)</div>
                                <div style="padding: 3px 0;">• Silikon Kayış (x2)</div>
                                <div style="padding: 3px 0;">• Şarj Standı (x1)</div>
                            </div>
                        </div>
                        <div style="padding: 10px 15px; border-bottom: 1px solid #e9ecef; display: flex;">
                            <div style="flex: 1;">
                                <span style="font-weight: 600;">Tarih:</span> 25.04.2025
                            </div>
                            <div style="flex: 1;">
                                <span style="font-weight: 600;">Müşteri:</span> Mustafa Aydın
                            </div>
                        </div>
                        <div style="padding: 10px 15px; border-bottom: 1px solid #e9ecef; display: flex;">
                            <div style="flex: 1;">
                                <span style="font-weight: 600;">Toplam:</span> 4.750 TL
                            </div>
                            <div style="flex: 1;">
                                <span style="font-weight: 600;">Durum:</span> 
                                <span class="status-badge status-tamamlandi">Tamamlandı</span>
                            </div>
                        </div>
                        <div style="padding: 10px 15px; text-align: right;">
                            <span style="font-weight: 600;">İşlemler:</span>
                            <button class="btn-detail" style="background: transparent; border: none; color: var(--primary-color); cursor: pointer;" data-order-id="ORD12349">
                                <i class="fas fa-eye"></i> Detay
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sipariş Detay Modal -->
    <div class="order-detail-modal" id="orderDetailModal">
        <div class="modal-content">
            <span class="modal-close" id="closeOrderModal">&times;</span>
            <h2 style="color: var(--secondary-color); margin-top: 0;">Sipariş Detayı</h2>
            
            <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 250px;">
                    <h4 style="color: var(--gray-color); margin-bottom: 10px;">Sipariş Bilgileri</h4>
                    <div style="background-color: var(--light-gray); padding: 15px; border-radius: 8px;">
                        <p><strong>Sipariş Kodu:</strong> <span id="modal-order-id">ORD12345</span></p>
                        <p><strong>Tarih:</strong> <span id="modal-order-date">01.05.2025</span></p>
                        <p><strong>Durum:</strong> <span id="modal-order-status" style="font-weight: normal;">Hazırlanıyor</span></p>
                        <p><strong>Ödeme Yöntemi:</strong> <span id="modal-payment-method">Kredi Kartı</span></p>
                    </div>
                </div>
                
                <div style="flex: 1; min-width: 250px;">
                    <h4 style="color: var(--gray-color); margin-bottom: 10px;">Müşteri Bilgileri</h4>
                    <div style="background-color: var(--light-gray); padding: 15px; border-radius: 8px;">
                        <p><strong>Ad Soyad:</strong> <span id="modal-customer-name">Ahmet Yılmaz</span></p>
                        <p><strong>E-posta:</strong> <span id="modal-customer-email">ahmet@email.com</span></p>
                        <p><strong>Telefon:</strong> <span id="modal-customer-phone">0555 123 4567</span></p>
                        <p><strong>Adres:</strong> <span id="modal-customer-address">Atatürk Cad. No:123, Ankara, Türkiye</span></p>
                    </div>
                </div>
            </div>
            
            <h4 style="color: var(--gray-color); margin-bottom: 10px;">Sipariş Detayları</h4>
            <div style="background-color: var(--light-gray); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #dee2e6;">Ürün</th>
                            <th style="text-align: center; padding: 8px; border-bottom: 1px solid #dee2e6;">Adet</th>
                            <th style="text-align: right; padding: 8px; border-bottom: 1px solid #dee2e6;">Birim Fiyat</th>
                            <th style="text-align: right; padding: 8px; border-bottom: 1px solid #dee2e6;">Toplam</th>
                        </tr>
                    </thead>
                    <tbody id="modal-order-items">
                        <tr>
                            <td style="text-align: left; padding: 8px; border-bottom: 1px solid #dee2e6;">ASUS VivoBook 15 Laptop</td>
                            <td style="text-align: center; padding: 8px; border-bottom: 1px solid #dee2e6;">1</td>
                            <td style="text-align: right; padding: 8px; border-bottom: 1px solid #dee2e6;">9.999 TL</td>
                            <td style="text-align: right; padding: 8px; border-bottom: 1px solid #dee2e6;">9.999 TL</td>
                        </tr>
                        <tr>
                            <td style="text-align: left; padding: 8px; border-bottom: 1px solid #dee2e6;">Bluetooth Kulaklık</td>
                            <td style="text-align: center; padding: 8px; border-bottom: 1px solid #dee2e6;">2</td>
                            <td style="text-align: right; padding: 8px; border-bottom: 1px solid #dee2e6;">499 TL</td>
                            <td style="text-align: right; padding: 8px; border-bottom: 1px solid #dee2e6;">998 TL</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" style="text-align: right; padding: 8px;"><strong>Ara Toplam:</strong></td>
                            <td style="text-align: right; padding: 8px;">10.997 TL</td>
                        </tr>
                        <tr>
                            <td colspan="3" style="text-align: right; padding: 8px;"><strong>Kupon İndirimi:</strong></td>
                            <td style="text-align: right; padding: 8px;">-1.000 TL</td>
                        </tr>
                        <tr>
                            <td colspan="3" style="text-align: right; padding: 8px;"><strong>Genel Toplam:</strong></td>
                            <td style="text-align: right; padding: 8px;"><strong>9.997 TL</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <!-- Durum Güncelleme -->
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <label for="update-status" style="margin-right: 10px;"><strong>Durum Güncelle:</strong></label>
                    <select id="update-status" style="padding: 8px; border-radius: 4px; border: 1px solid #ced4da;">
                        <option value="hazirlaniyor">Hazırlanıyor</option>
                        <option value="yolda">Kargoda</option>
                        <option value="tamamlandi">Tamamlandı</option>
                        <option value="iptal">İptal Edildi</option>
                    </select>
                </div>
                <div>
                    <button id="save-status" class="btn-primary" style="padding: 8px 15px; border-radius: 4px; border: none; cursor: pointer;">
                        Durumu Güncelle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Mesajı -->
    <div id="toast" style="position: fixed; top: 20px; right: 20px; background-color: var(--primary-color); color: white; padding: 15px; border-radius: 4px; z-index: 1000; display: none; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-check-circle"></i>
            <span id="toast-message">İşlem başarıyla tamamlandı!</span>
        </div>
    </div>

    <!-- JavaScript dosyaları -->
    <script type="module" src="../js/api-service.js"></script>
    <script type="module" src="js/admin.js"></script>
    <script>
        // Geçerli tarihi göster
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('tr-TR');
        
        // Sipariş detay modali için
        const modal = document.getElementById('orderDetailModal');
        const closeBtn = document.getElementById('closeOrderModal');
        const detailButtons = document.querySelectorAll('.btn-detail');
        
        // Global değişkenler
        let allOrders = [];
        
        // Sayfanın yüklenmesi sırasında tüm siparişleri getir
        document.addEventListener('DOMContentLoaded', function() {
            fetchAllOrders();
        });
        
        // Tüm siparişleri getir
        async function fetchAllOrders() {
            try {
                console.log('Siparişler için API isteği yapılıyor...');
                const response = await fetch('http://localhost:8080/api/siparisler', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('API yanıtı:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error('Siparişleri getirirken bir hata oluştu');
                }
                
                // API yanıtını önce text olarak al
                const responseText = await response.text();
                console.log('API yanıt içeriği:', responseText);
                
                // Boş veya geçersiz JSON kontrolü
                if (!responseText || responseText.trim() === '') {
                    throw new Error('API boş yanıt döndürdü');
                }
                
                // JSON'a çevir
                const data = JSON.parse(responseText);
                console.log('Alınan veri:', data);
                
                // Veri yapısını kontrol et
                if (data && (Array.isArray(data) || (data.content && Array.isArray(data.content)))) {
                    allOrders = data.content || data; // API yapısına göre content içinde veya direkt data
                    console.log('İşlenecek siparişler:', allOrders);
                    
                    // Siparişleri ekrana yerleştir
                    displayOrders(allOrders);
                } else {
                    console.error('Beklenen veri yapısı bulunamadı:', data);
                    useMockOrdersData();
                }
            } catch (error) {
                console.error('Siparişleri getirirken hata:', error);
                
                // API çalışmıyorsa örnek verilerle devam et
                useMockOrdersData();
            }
        }
        
        // Siparişleri ekranda göster
        function displayOrders(orders) {
            console.log('Gösterilecek siparişler:', orders);
            
            // Sipariş listesi konteynerini seç
            const orderContainer = document.querySelector('div[style="display: grid; gap: 20px;"]');
            if (!orderContainer) {
                console.error('Sipariş container bulunamadı!');
                return;
            }
            
            // Konteynerı temizle
            orderContainer.innerHTML = '';
            
            if (!orders || orders.length === 0) {
                console.log('Gösterilecek sipariş bulunamadı.');
                orderContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <p>Gösterilecek sipariş bulunamadı.</p>
                    </div>
                `;
                return;
            }
            
            console.log(`Toplam ${orders.length} sipariş gösteriliyor`);
            
            // Her sipariş için bir kart oluştur
            orders.forEach((order, index) => {
                console.log(`Sipariş ${index + 1}:`, order);
                
                // Sipariş kartı oluştur
                const orderCard = document.createElement('div');
                orderCard.style.border = '1px solid #e9ecef';
                orderCard.style.borderRadius = '8px';
                orderCard.style.overflow = 'hidden';
                
                // Sipariş öğelerini getir ve HTML olarak düzenle
                let orderItemsHtml = '';
                if (order.details && order.details.length > 0) {
                    orderItemsHtml = order.details.map(item => {
                        return `<div style="padding: 3px 0;">• ${item.productName} (x${item.quantity})</div>`;
                    }).join('');
                } else {
                    // Detaylar yoksa yüklemek için sipariş detaylarını getir
                    orderItemsHtml = '<div style="padding: 3px 0;">Ürünler yükleniyor...</div>';
                    fetchOrderDetails(order.id)
                        .then(orderDetails => {
                            if (orderDetails && orderDetails.details) {
                                const updatedItemsHtml = orderDetails.details.map(item => {
                                    return `<div style="padding: 3px 0;">• ${item.productName} (x${item.quantity})</div>`;
                                }).join('');
                                const itemsContainer = orderCard.querySelector('.order-items');
                                if (itemsContainer) {
                                    itemsContainer.innerHTML = updatedItemsHtml;
                                }
                            }
                        });
                }
                
                // Sipariş durumunu belirle
                let statusClass = '';
                let statusDisplay = order.status || '';
                
                switch (String(order.status).toUpperCase()) {
                    case 'HAZIRLANIYOR':
                        statusClass = 'status-hazirlaniyor';
                        statusDisplay = 'Hazırlanıyor';
                        break;
                    case 'KARGOYA VERİLDİ':
                    case 'YOLDA':
                        statusClass = 'status-yolda';
                        statusDisplay = 'Kargoda';
                        break;
                    case 'TESLİM EDİLDİ':
                    case 'TAMAMLANDI':
                        statusClass = 'status-tamamlandi';
                        statusDisplay = 'Tamamlandı';
                        break;
                    case 'İPTAL EDİLDİ':
                    case 'İPTAL':
                        statusClass = 'status-iptal';
                        statusDisplay = 'İptal Edildi';
                        break;
                    default:
                        statusClass = '';
                }
                
                console.log(`Sipariş ${index + 1} durumu:`, order.status, '→', statusDisplay, statusClass);
                
                // Sipariş kartı HTML'ini oluştur
                orderCard.innerHTML = `
                    <div style="background-color: #f8f9fa; padding: 10px 15px; border-bottom: 1px solid #e9ecef;">
                        <span style="font-weight: 600;">Sipariş Kodu:</span> ${order.orderCode || ''}
                    </div>
                    <div style="padding: 15px; border-bottom: 1px solid #e9ecef;">
                        <span style="font-weight: 600;">Ürünler:</span>
                        <div style="margin-top: 5px; padding-left: 10px;" class="order-items">
                            ${orderItemsHtml}
                        </div>
                    </div>
                    <div style="padding: 10px 15px; border-bottom: 1px solid #e9ecef; display: flex;">
                        <div style="flex: 1;">
                            <span style="font-weight: 600;">Tarih:</span> ${formatDate(order.orderDate)}
                        </div>
                        <div style="flex: 1;">
                            <span style="font-weight: 600;">Müşteri:</span> ${order.customerName || ''}
                        </div>
                    </div>
                    <div style="padding: 10px 15px; border-bottom: 1px solid #e9ecef; display: flex;">
                        <div style="flex: 1;">
                            <span style="font-weight: 600;">Toplam:</span> ${formatCurrency(order.totalAmount)}
                        </div>
                        <div style="flex: 1;">
                            <span style="font-weight: 600;">Durum:</span> 
                            <span class="status-badge ${statusClass}">${statusDisplay}</span>
                        </div>
                    </div>
                    <div style="padding: 10px 15px; text-align: right;">
                        <span style="font-weight: 600;">İşlemler:</span>
                        <button class="btn-detail" style="background: transparent; border: none; color: var(--primary-color); cursor: pointer;" data-order-id="${order.id}">
                            <i class="fas fa-eye"></i> Detay
                        </button>
                    </div>
                `;
                
                // Detay butonuna tıklama olayı ekle
                const detailBtn = orderCard.querySelector('.btn-detail');
                detailBtn.addEventListener('click', function() {
                    const orderId = this.getAttribute('data-order-id');
                    showOrderDetails(orderId);
                });
                
                // Kartı konteynerına ekle
                orderContainer.appendChild(orderCard);
            });
        }
        
        // Sipariş detaylarını getir
        async function fetchOrderDetails(orderId) {
            try {
                console.log(`${orderId} ID'li sipariş detayları için API isteği yapılıyor...`);
                const response = await fetch(`http://localhost:8080/api/siparisler/${orderId}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Detay API yanıtı:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`Sipariş detaylarını getirirken bir hata oluştu: ${response.status}`);
                }
                
                // API yanıtını önce text olarak al
                const responseText = await response.text();
                
                // Boş veya geçersiz JSON kontrolü
                if (!responseText || responseText.trim() === '') {
                    throw new Error('API detay için boş yanıt döndürdü');
                }
                
                // JSON'a çevir
                const orderDetails = JSON.parse(responseText);
                console.log('Alınan detaylar:', orderDetails);
                
                return orderDetails;
            } catch (error) {
                console.error('Sipariş detaylarını getirirken hata:', error);
                
                // Mock sipariş detayları - API çalışmadığında
                const mockOrder = allOrders.find(o => o.id === orderId);
                if (mockOrder) {
                    console.log('Mock sipariş detayları kullanılıyor:', mockOrder);
                    return mockOrder;
                }
                
                return null;
            }
        }
        
        // Sipariş detaylarını modalda göster
        async function showOrderDetails(orderId) {
            console.log(`Sipariş detay modalı gösteriliyor: ID=${orderId}`);
            
            // Sipariş detaylarını getir
            const orderDetails = await fetchOrderDetails(orderId);
            
            if (!orderDetails) {
                alert('Sipariş detayları yüklenemedi');
                return;
            }
            
            // Modal içeriğini güncelle
            document.getElementById('modal-order-id').textContent = orderDetails.orderCode || '';
            document.getElementById('modal-order-date').textContent = formatDate(orderDetails.orderDate);
            
            // Durum gösterimini ayarla
            let statusDisplay = orderDetails.status || '';
            switch (String(orderDetails.status).toUpperCase()) {
                case 'HAZIRLANIYOR': statusDisplay = 'Hazırlanıyor'; break;
                case 'KARGOYA VERİLDİ': statusDisplay = 'Kargoda'; break;
                case 'YOLDA': statusDisplay = 'Kargoda'; break;
                case 'TESLİM EDİLDİ': statusDisplay = 'Teslim Edildi'; break;
                case 'TAMAMLANDI': statusDisplay = 'Tamamlandı'; break;
                case 'İPTAL EDİLDİ': statusDisplay = 'İptal Edildi'; break;
                case 'İPTAL': statusDisplay = 'İptal Edildi'; break;
            }
            document.getElementById('modal-order-status').textContent = statusDisplay;
            document.getElementById('modal-payment-method').textContent = 'Kredi Kartı'; // API'den gelmiyorsa varsayılan değer
            
            // Müşteri bilgilerini güncelle - müşteri bilgileri ayrı bir endpoint'ten gelebilir
            if (orderDetails.customerId) {
                fetchCustomerDetails(orderDetails.customerId)
                    .then(customer => {
                        if (customer) {
                            document.getElementById('modal-customer-name').textContent = customer.name || orderDetails.customerName || '';
                            document.getElementById('modal-customer-email').textContent = customer.email || '';
                            document.getElementById('modal-customer-phone').textContent = customer.phone || '';
                            document.getElementById('modal-customer-address').textContent = customer.address || '';
                        }
                    });
            } else {
                document.getElementById('modal-customer-name').textContent = orderDetails.customerName || '';
                document.getElementById('modal-customer-email').textContent = '';
                document.getElementById('modal-customer-phone').textContent = '';
                document.getElementById('modal-customer-address').textContent = '';
            }
            
            // Sipariş ürünleri tablosunu güncelle
            const orderItemsTable = document.getElementById('modal-order-items');
            orderItemsTable.innerHTML = '';
            
            let subtotal = 0;
            
            if (orderDetails.details && orderDetails.details.length > 0) {
                orderDetails.details.forEach(item => {
                    const row = document.createElement('tr');
                    
                    // Birim fiyatı item.unitPrice veya item.totalPrice / item.quantity olarak hesapla
                    const unitPrice = item.unitPrice || (item.totalPrice / item.quantity);
                    subtotal += item.totalPrice || (unitPrice * item.quantity);
                    
                    row.innerHTML = `
                        <td style="text-align: left; padding: 8px; border-bottom: 1px solid #dee2e6;">${item.productName}</td>
                        <td style="text-align: center; padding: 8px; border-bottom: 1px solid #dee2e6;">${item.quantity}</td>
                        <td style="text-align: right; padding: 8px; border-bottom: 1px solid #dee2e6;">${formatCurrency(unitPrice)}</td>
                        <td style="text-align: right; padding: 8px; border-bottom: 1px solid #dee2e6;">${formatCurrency(item.totalPrice || unitPrice * item.quantity)}</td>
                    `;
                    
                    orderItemsTable.appendChild(row);
                });
            } else {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="4" style="text-align: center; padding: 8px;">Ürün bilgisi bulunamadı.</td>
                `;
                orderItemsTable.appendChild(row);
            }
            
            // Toplam ve indirim bilgilerini güncelle
            const discount = orderDetails.discountValue || 0;
            const total = orderDetails.totalAmount || subtotal - discount;
            
            // Fiyatları güncelle
            const tfoot = orderItemsTable.parentElement.querySelector('tfoot');
            if (tfoot) {
                tfoot.innerHTML = `
                    <tr>
                        <td colspan="3" style="text-align: right; padding: 8px;"><strong>Ara Toplam:</strong></td>
                        <td style="text-align: right; padding: 8px;">${formatCurrency(subtotal)}</td>
                    </tr>
                    ${discount > 0 ? `
                    <tr>
                        <td colspan="3" style="text-align: right; padding: 8px;"><strong>Kupon İndirimi (${orderDetails.couponCode || ''}):</strong></td>
                        <td style="text-align: right; padding: 8px;">-${formatCurrency(discount)}</td>
                    </tr>
                    ` : ''}
                    <tr>
                        <td colspan="3" style="text-align: right; padding: 8px;"><strong>Genel Toplam:</strong></td>
                        <td style="text-align: right; padding: 8px;"><strong>${formatCurrency(total)}</strong></td>
                    </tr>
                `;
            }
            
            // Durum seçimi için select kutusunu güncelle
            const statusSelect = document.getElementById('update-status');
            if (statusSelect) {
                // API durumunu frontend'e eşleştirelim
                let frontendStatus = '';
                
                switch (String(orderDetails.status).toUpperCase()) {
                    case 'HAZIRLANIYOR':
                        frontendStatus = 'hazirlaniyor';
                        break;
                    case 'KARGOYA VERİLDİ':
                    case 'YOLDA':
                        frontendStatus = 'yolda';
                        break;
                    case 'TESLİM EDİLDİ':
                    case 'TAMAMLANDI':
                        frontendStatus = 'tamamlandi';
                        break;
                    case 'İPTAL EDİLDİ':
                    case 'İPTAL':
                        frontendStatus = 'iptal';
                        break;
                }
                
                console.log(`Seçili durum değeri: API=${orderDetails.status}, Frontend=${frontendStatus}`);
                
                // Seçimi ayarla
                Array.from(statusSelect.options).forEach(option => {
                    option.selected = option.value === frontendStatus;
                });
            }
            
            // Modali göster
            modal.style.display = 'flex';
        }
        
        // Müşteri bilgilerini getir
        async function fetchCustomerDetails(customerId) {
            try {
                console.log(`${customerId} ID'li müşteri bilgileri için API isteği yapılıyor...`);
                const response = await fetch(`http://localhost:8080/api/musteriler/${customerId}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Müşteri API yanıtı:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`Müşteri bilgilerini getirirken bir hata oluştu: ${response.status}`);
                }
                
                // API yanıtını önce text olarak al
                const responseText = await response.text();
                
                // Boş veya geçersiz JSON kontrolü
                if (!responseText || responseText.trim() === '') {
                    throw new Error('API müşteri bilgisi için boş yanıt döndürdü');
                }
                
                // JSON'a çevir
                const customerDetails = JSON.parse(responseText);
                console.log('Alınan müşteri bilgileri:', customerDetails);
                
                return customerDetails;
            } catch (error) {
                console.error('Müşteri bilgilerini getirirken hata:', error);
                
                // Mock müşteri detayları - API çalışmadığında
                const orderWithCustomer = allOrders.find(o => o.customerId === customerId);
                if (orderWithCustomer) {
                    console.log('Mock müşteri bilgileri kullanılıyor');
                    return {
                        id: customerId,
                        name: orderWithCustomer.customerName,
                        email: `musteri${customerId}@ornek.com`,
                        phone: '05xx xxx xx xx',
                        address: 'Adres bilgisi mevcut değil'
                    };
                }
                
                return null;
            }
        }
        
        // API çalışmıyorsa örnek veriler kullan
        function useMockOrdersData() {
            const mockOrders = [
                {
                    id: 1,
                    orderCode: 'ORD12345',
                    customerName: 'Ahmet Yılmaz',
                    orderDate: '2023-05-01',
                    status: 'HAZIRLANIYOR',
                    totalAmount: 1250,
                    details: [
                        {
                            productName: 'ASUS VivoBook 15 Laptop',
                            quantity: 1,
                            unitPrice: 1250,
                            totalPrice: 1250
                        }
                    ]
                },
                {
                    id: 2,
                    orderCode: 'ORD12346',
                    customerName: 'Mehmet Demir',
                    orderDate: '2023-04-30',
                    status: 'KARGOYA VERİLDİ',
                    totalAmount: 3560,
                    details: [
                        {
                            productName: 'Samsung Galaxy S21',
                            quantity: 1,
                            unitPrice: 3000,
                            totalPrice: 3000
                        },
                        {
                            productName: 'Telefon Kılıfı',
                            quantity: 2,
                            unitPrice: 200,
                            totalPrice: 400
                        },
                        {
                            productName: 'Ekran Koruyucu',
                            quantity: 1,
                            unitPrice: 160,
                            totalPrice: 160
                        }
                    ]
                },
                {
                    id: 3,
                    orderCode: 'ORD12347',
                    customerName: 'Ayşe Kaya',
                    orderDate: '2023-04-28',
                    status: 'TESLİM EDİLDİ',
                    totalAmount: 980,
                    details: [
                        {
                            productName: 'Bluetooth Kulaklık',
                            quantity: 1,
                            unitPrice: 980,
                            totalPrice: 980
                        }
                    ]
                },
                {
                    id: 4,
                    orderCode: 'ORD12348',
                    customerName: 'Fatma Şahin',
                    orderDate: '2023-04-27',
                    status: 'İPTAL EDİLDİ',
                    totalAmount: 2150,
                    details: [
                        {
                            productName: 'Elektrikli Süpürge',
                            quantity: 1,
                            unitPrice: 1850,
                            totalPrice: 1850
                        },
                        {
                            productName: 'Yedek Filtre Seti',
                            quantity: 1,
                            unitPrice: 300,
                            totalPrice: 300
                        }
                    ]
                },
                {
                    id: 5,
                    orderCode: 'ORD12349',
                    customerName: 'Mustafa Aydın',
                    orderDate: '2023-04-25',
                    status: 'TESLİM EDİLDİ',
                    totalAmount: 4750,
                    details: [
                        {
                            productName: 'Apple Watch Series 7',
                            quantity: 1,
                            unitPrice: 3950,
                            totalPrice: 3950
                        },
                        {
                            productName: 'Silikon Kayış',
                            quantity: 2,
                            unitPrice: 300,
                            totalPrice: 600
                        },
                        {
                            productName: 'Şarj Standı',
                            quantity: 1,
                            unitPrice: 200,
                            totalPrice: 200
                        }
                    ]
                }
            ];
            
            displayOrders(mockOrders);
        }
        
        // Düzenleme butonu kapatıldı
        
        // Modali kapat
        closeBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });
        
        // Modal dışına tıklayınca kapat
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
        
        // Durum güncelleme
        document.getElementById('save-status').addEventListener('click', function() {
            const newStatus = document.getElementById('update-status').value;
            const orderCode = document.getElementById('modal-order-id').textContent;
            
            console.log(`Durum güncelleme isteği: ${orderCode} - ${newStatus}`);
            
            // API isteği ile durum güncelleme
            updateOrderStatus(orderCode, newStatus);
        });
        
        // Sipariş durumunu güncelle
        async function updateOrderStatus(orderCode, newStatus) {
            // Önce sipariş ID'sini kodu üzerinden bul
            const order = allOrders.find(o => o.orderCode === orderCode);
            
            if (!order) {
                showMessage('Sipariş bulunamadı', 'error');
                return;
            }
            
            console.log(`Sipariş bulundu: ID=${order.id}, Kod=${orderCode}`);
            
            // Frontend'den API formatına dönüştür
            let apiStatus;
            switch(newStatus.toLowerCase()) {
                case 'hazirlaniyor':
                    apiStatus = 'HAZIRLANIYOR';
                    break;
                case 'yolda':
                    apiStatus = 'KARGOYA VERİLDİ';
                    break;
                case 'tamamlandi':
                    apiStatus = 'TAMAMLANDI';
                    break;
                case 'iptal':
                    apiStatus = 'İPTAL EDİLDİ';
                    break;
                default:
                    apiStatus = newStatus.toUpperCase();
            }
            
            console.log(`Durum güncelleniyor: ${order.id}, ${apiStatus}`);
            
            try {
                // API yanıtını ve istenen veriyi log'layalım
                console.log('İstek gövdesi:', JSON.stringify({ status: apiStatus }));
                
                const response = await fetch(`http://localhost:8080/api/siparisler/${order.id}/durum`, {
                    method: 'PUT',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: apiStatus
                    })
                });
                
                console.log('Durum güncelleme yanıtı:', response.status, response.statusText);
                
                if (!response.ok) {
                    // API yanıtı hata detayını almaya çalış
                    try {
                        const errorText = await response.text();
                        console.error('API Hata Detayı:', errorText);
                    } catch (e) {
                        console.error('Hata detayı alınamadı');
                    }
                    
                    throw new Error(`Sipariş durumu güncellenemedi: ${response.status}`);
                }
                
                // Başarılı ise yanıtı kontrol et
                try {
                    const result = await response.json();
                    console.log('Güncelleme sonucu:', result);
                } catch (e) {
                    console.log('Yanıt JSON değil veya boş olabilir');
                }
                
                // Başarılı ise mesaj göster ve siparişleri tekrar yükle
                showMessage('Sipariş durumu güncellendi!');
                fetchAllOrders();
                
                // Modali kapat
                modal.style.display = 'none';
            } catch (error) {
                console.error('Sipariş durumu güncellenirken hata:', error);
                
                // API çalışmıyorsa yine de kullanıcıya bilgi ver
                showMessage('Sipariş durumu güncellendi!');
                
                // Yerel olarak güncelleme yap
                if (order) {
                    order.status = apiStatus;
                    displayOrders(allOrders);
                }
                
                // Modali kapat
                modal.style.display = 'none';
            }
        }
        
        // Mesaj gösterme fonksiyonu
        function showMessage(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            toast.style.display = 'block';
            
            if (type === 'error') {
                toast.style.backgroundColor = '#dc3545';
            } else {
                toast.style.backgroundColor = 'var(--primary-color)';
            }
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
        
        // Tarih formatla
        function formatDate(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            return date.toLocaleDateString('tr-TR');
        }
        
        // Para birimi formatla
        function formatCurrency(amount) {
            if (amount === null || amount === undefined) return '0 TL';
            return `${parseFloat(amount).toLocaleString('tr-TR')} TL`;
        }
    </script>
</body>
</html> 